%*****************************************************************************************************************************************%
%*********************************************************** `pkgopts.sty' ***************************************************************%
%*****************************************************************************************************************************************%
% Expands upon the 'kvoptions' package to add another '\DeclareXOption' package option key command corresponding to the key type 'X=Choice', analagous to the 'define@choicekey' command of the 'keyval' package, thereby providing key/value package option equivalents to each of the primary key types defined by the 'keyval' package.   
%*****************************************************************************************************************************************%
%*************************************** Define provided package name and LaTeX/package dependencies *************************************%
%*****************************************************************************************************************************************%
\NeedsTeXFormat{LaTeX2e}[2005/12/01]
\ProvidesPackage{pkgopts}                    	%
%-----------------------------------------------------------------------------------------------------------------------------------------%
%*****************************************************************************************************************************************%
%****************************************** Package options and corresponding Boolean variables ******************************************%
%*****************************************************************************************************************************************%
%-----------------------------------------------------------------------------------------------------------------------------------------%
\DeclareOption*{\PackageWarning{pkgopts}{Unknown \CurrentOption}}
%*****************************************************************************************************************************************%
%***************************************************** Processing of package options *****************************************************%
%*****************************************************************************************************************************************%
%-----------------------------------------------------------------------------------------------------------------------------------------%
\ProcessOptions\relax
%-----------------------------------------------------------------------------------------------------------------------------------------%
%\catcode`\!=12
%\makeatletter                          % Change @ to standard letter, \catcode'@=11 so it can be used in macro names/definition
%*****************************************************************************************************************************************%
%************************************************************* Package Body **************************************************************%
%*****************************************************************************************************************************************%
%-----------------------------------------------------------------------------------------------------------------------------------------%
\def\reportname{report}
\def\articlename{article}
\def\@csname#1{\csname #1\endcsname}
\def\pkgname{my-latex}%
%\edef\my@options@list{\my@options@list,#2}%
%-----------------------------------------------------------------------------------------------------------------------------------------%
\def\fullyexpand#1{\romannumeral - `0#1}
\def\IndentedMessageBreak{\MessageBreak\space\space\space\space}
\def\DoubleIndentedMessageBreak{\MessageBreak\space\space\space\space\space\space\space\space}
\xdef\DoubleIndented{\space\space\space\space\space\space\space\space}
\newif\if@pkgopts@packages@loaded@\@pkgopts@packages@loaded@false
\newcommand\@init@pkgopts@packages{etoolbox,forarray}
\newcommand\@pkgopts@packages{kvoptions,xstring,xparse,etoolbox,pgffor,forarray,trimspaces}
%*****************************************************************************************************************************************%
%************************************************************* Package Body **************************************************************%
%*****************************************************************************************************************************************%
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\RequirePackageInit[1]
{%
        \@for\next:=#1\do{\RequirePackage{\next}}%
        \newcommand\@loaded@packages{#1}%
        \@pkgopts@packages@loaded@true%
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\RequirePackageOnce[1]
{%    
        \@ifpackageloaded{#1}{}%
        {%
        	\RequirePackage{#1}%
        	%\csxappto{@loaded@packages}{,#1}%
        	\ifundef{\@loaded@packages}%
	                {\edef\@loaded@packages{#1}}%
	                {\edef\@loaded@packages{\@loaded@packages,#1}}%
        }%	
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\RequirePackageList[1]
{%
	\if@pkgopts@packages@loaded@\else\RequirePackageInit{\@init@pkgopts@packages}\fi
	\ForEachX{,}{\RequirePackageOnce{\thislevelitem}}{#1}
}
%*****************************************************************************************************************************************%
%************************************************************* Package Body **************************************************************%
%*****************************************************************************************************************************************%
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\DeclareChoiceOptionMessage[2][\KVO@prefix]%
{%
        \gdef\msgtext{\string\DeclareChoiceOption\space Error%
        \MessageBreak Invalid choice '#1#2\space=\space\csname #1#2\endcsname'}%
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\DeclareChoiceOptionHelp[2][\KVO@prefix]%
{%
        \gdef\hlptext{\string\DeclareChoiceOption\space Help:%
        \IndentedMessageBreak Valid '#1#2' Options:%
        \MessageBreak\IndentedMessageBreak #2\space=\space{\csname @#1valid@#2@choice@options\endcsname}}%
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\DeclareChoiceOptionError[2][\KVO@prefix]%
{%
        \DeclareChoiceOptionMessage[#1]{#2}%
        \DeclareChoiceOptionHelp[#1]{#2}%
        \@PackageError\pkgname\msgtext\hlptext%
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\def\DeclareChoiceOption(#1)#2[#3]#4%
{%\DeclareChoiceOption<*>(<prefix>){<key>}[<default>]{<valid key values>}
        \ifstrempty{#3}
        	{\DeclareStringOption{#2}}%
                {\DeclareStringOption{#2}[#3]}%
        \ifstrempty{#1}
                {\def\@current@prefix{\KVO@prefix}}%
               	{\def\@current@prefix{#1}}%
        %\edef\my@options@list{\my@options@list,#2}     
        \ifundef{\@defined@Choice@Options}%
        	{\edef\@defined@Choice@Options{#2}}%
        	{\edef\@defined@Choice@Options{\@defined@Choice@Options,#2}}%  
        \expandafter\newif\csname if\@current@prefix#2\endcsname%
        \expandafter\gdef\csname @\@current@prefix valid@#2@choice@options\endcsname{#4}%
        \expandafter\xdef\csname @#2@prefix\endcsname{\@current@prefix}%
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\ProcessChoiceOption[2][\KVO@prefix]%
{%\ProcessChoiceOption<*>(<prefix>){<key>}[<default>]
        \expandafter\ifdefempty\expandafter{\csname#1#2\endcsname}%
                {}{\csname #1#2true\endcsname}%
        \expandafter\csname if\csname @\next @prefix\endcsname\next\endcsname\relax%
                \def\@validated{false}%
	        \xdef\@valid@choice@options{\csname @#1valid@#2@choice@options\endcsname}%
	        \ForEachX{,}%
	        {%
	                \IfEq{\csname #1#2\endcsname}{\thislevelitem}%
	                {\def\@validated{true}}{}%
	        }%
	        {\@valid@choice@options}%
	        \IfStrEq{\@validated}{true}{}{\DeclareChoiceOptionError[#1]{#2}}%
        \fi%   
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\ProcessChoiceOptions{\@for\next:=\@defined@Choice@Options\do{\ProcessChoiceOption[\csname @\next @prefix\endcsname]{\next}}}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\ProcessPackageOptions[1][]%
{%
        \ifstrempty{#1}%
                {\ProcessKeyvalOptions*}%
                {\ProcessKeyvalOptions{#1}}%
        \ProcessChoiceOptions%
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\PrintChoiceInfo[2][]%
{%\ProcessChoiceOption<*>(<prefix>){<key>}[<default>]
        \noindent \underline{Defined Choice Keys} : \@defined@Choice@Options\\%
        \indent \underline{Choice key (family@key)} : \csname @#2@prefix\endcsname#2\\
        \expandafter\csname if\csname @#2@prefix\endcsname#2\endcsname\relax%
                \indent\indent \underline{Provided} = true\\%
                \indent\indent \underline{Acceptable Choices} = %
                \ifstrempty{#1}
                	{\fullyexpand{\csname @\csname @#2@prefix\endcsname valid@#2@choice@options\endcsname}\\}%
                	{\fullyexpand{\csname @#2@prefix@valid@#2@choice@options\endcsname}\\}%       
                \indent\indent \underline{Selected Choice} = \expandafter\csname\csname @#2@prefix\endcsname#2\endcsname\\
        \else%
                \indent\indent \underline{Provided} = false\\%
        \fi%        
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\PrintPackageList{\noindent \underline{Loaded Packages} : \@loaded@packages}
%-----------------------------------------------------------------------------------------------------------------------------------------%
\newcommand\SetDocumentClass[1][\KVO@prefix]%
{%\ProcessChoiceOption<*>(<prefix>){<key>}[<default>]
        \ifstrempty{\csname #1documentclass\endcsname}
                {\def\thedocumentclass{report}}%
                {\def\thedocumentclass{\csname #1documentclass\endcsname}}%
        \ifmylatex@article
		\def\thedocumentclass{article}
	\fi
	\ifmylatex@report
		\def\thedocumentclass{report}
        \fi
        \ifmylatex@standaloneoff
		\documentclass{\thedocumentclass}
	\else
		\documentclass[class=\thedocumentclass, crop=false]{standalone}
	\fi
}
%-----------------------------------------------------------------------------------------------------------------------------------------%
%*****************************************************************************************************************************************%
%***************************************************** End of 'pkgopts.sty' package ******************************************************%
%*****************************************************************************************************************************************%
%-----------------------------------------------------------------------------------------------------------------------------------------%
\endinput 